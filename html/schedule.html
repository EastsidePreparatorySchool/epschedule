<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">

<dom-module id="x-schedule">
  <style>
    /* TODO(polyup): For speed, consider reworking these styles with .classes
                     and #ids rather than [attributes].
    */
    [layout] {
      @apply(--layout);
    }
    [layout][vertical] {
      @apply(--layout-vertical);
    }
    [layout][center] {
      @apply(--layout-center);
    }
  </style>
  <style>
    :host {
      width: 100%;
      display: block;
      position: relative;
      background-color: #efefef;
      font-size: 1.2rem;
      font-weight: 300;
      margin-bottom: 1px;
      border-radius: 2px;
      transition: 150ms cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    :host-context(.no-transition) {
      transition: none;
    }
    .card {
      margin-bottom: 1px;
      cursor: pointer;
    }
    .card-header {
      background-color: white;
      transition: background-color ease-in 300ms;
    }
    .card-header.current {
      background-color: rgba(33, 150, 243, 0.25);
    }
    .card-header.no-transition {
      transition: none;
    }
    .card-header ::content img {
      width: 48px;
      padding: 1px;
      border-radius: 50%;
      margin: 16px;
      background: #efefef url() center center no-repeat;
    }
    .card-header ::content h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 300;
    }
    .card-header ::content p {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 300;
      color: gray;
    }
    .card-header ::content a {
      color: gray;
      font-weight: 300;
      text-decoration: none;
    }
    .card-header ::content a:hover {
      color: #2196f3;
    }
    .selected {
    }
    iron-collapse {
      background: #efefef;
    }
    .student {
      background: white;
      /* uncomment to enable gray lines between students
      #margin-bottom: 1px;*/
    }
    .student img {
      width: 32px;
      padding: 1px;
      border-radius: 50%;
      margin-left: 24px;
      margin-right: 24px;
      background: #efefef; /*url() center center no-repeat;*/
    }
    .student p {
      font-size: 16px; #0.9rem;
    }
    .student iron-icon {
      margin-right: 24px;
    }
    .student a {
      color: gray;
    }
    .student a:hover {
      color: #2196f3;
    }
  </style>
  <template>
    <paper-material class="xcard" elevation="2" on-track="handleTrack">
    <div layout="" vertical="">
      <template is="dom-repeat" id="entryList" items="{{entries}}">
        <div class="card" layout="" vertical="" xcenter="" on-tap="toggleExpand">
          <div class="card-header" layout="" horizontal="" center="">
            <img src="{{item.avatar}}" width="48" height="48">
            <div class="card-mid" layout="" vertical="">
              <p item="time"><span>{{item.startTime}}</span> - <span>{{item.endTime}}</span>
                <template is="dom-if" if="{{hasTeacherAndRoom(item)}}">
                  (<a on-click="teacherThunk" item="link" href="#">{{item.teacherLastName}}</a>,
                  <a on-click="roomThunk" item="link" href="#">{{item.room}}</a>)
                </template>
                <template is="dom-if" if="{{hasTeacherOnly(item)}}">
                  (<a on-click="teacherThunk" item="link" href="#">{{item.teacherLastName}}</a>)
                </template>
                <template is="dom-if" if="{{hasRoomOnly(item)}}">
                  (<a on-click="roomThunk" item="link" href="#">{{item.room}}</a>)
                </template>
              </p>
              <h2>{{item.name}}</h2>
            </div>
          </div>
          <iron-collapse id="{{computeCollapseId(item.name)}}">
            <div layout vertical>
              <template is="dom-repeat" items="{{item.students}}">
                <div class="student" layout="" horizontal="" center="" on-tap="studentThunk">
                  <img src="/images/material_face.svg" width="32" height="32">
                  <div class="flex">
                    <p>
                      <span>{{item.firstname}}</span> <span>{{item.lastname}}</span>
                    </p>
                  </div>
                  <a href="{{computeEmailLink(item.email)}}">
                    <iron-icon icon="communication:email"></iron-icon>
                  </a>
                </div>
              </template>
            </div>
          </iron-collapse>
        </div>
      </template>
    </div>
    </paper-material>
  </template>
  <script>
    Polymer({
      is: 'x-schedule',
      listeners: {
        "transitionend": "transitionEnd"
      },
      date: null,     // a Date corresponding to the schedule date
      entries: [],    // the actual class objects
      timer: null,    // background timer for adjusting the 'current' item
      offset: 0,      // for debugging; allows adjustment of current time
      swiped: false,  // whether a complete swipe was done
      dest: null,     // the destination of a swipe translation
      ready: function() {
        // disable vertical gestures on the card
        this.querySelector('paper-material').setScrollDirection('y');
      },
      // Update the data model with the specified date and class entries.
      render: function(date, entries) {
        this.date = date;
        this.entries = entries;
        var that = this;
        setTimeout(function() { that.updateCurrentEntry(false); }, 0);
      },
      // Create a complete date from a partial date and a time string.
      makeDate: function(date, timeStr) {
        var ret = new Date(date.getTime());
        var split = timeStr.split(':');
        ret.setHours(split[0]);
        ret.setMinutes(split[1]);
        ret.setSeconds(0);  // TODO(juberti): shouldn't have to do this.
        if (ret.getHours() < 7) {
          ret.setHours(ret.getHours() + 12);
        }
        return ret;
      },
      // Returns a date object corresponding to what we think 'now' is.
      getNow: function() {
        var now = new Date();
        now.setTime(now.getTime() + this.offset);
        return now;
      },
      // Computes the current class and applies the 'current' style to it.
      // Sets a timer for when the class ends to do this again.
      updateCurrentEntry: function(enableTransition) {
        var now = this.getNow();
        var elements = this.querySelectorAll('.card-header');
        var oldCurrent;
        var newCurrent;
        for (var i = 0; i < elements.length; ++i) {
          if (!newCurrent && now.getDate() == this.date.getDate()) {
            var item = this.$.entryList.itemForElement(elements[i]);
            var startDate = this.makeDate(this.date, item.startTime);
            var endDate = this.makeDate(this.date, item.endTime);
            if (now < endDate) {
              console.log('New current element: end time ' + endDate + ' now=' + now);
              newCurrent = elements[i];
            }
          }
          if (elements[i].classList.contains('current')) {
            oldCurrent = elements[i];
          }
        }

        if (oldCurrent) {
          oldCurrent.classList.toggle('no-transition', !enableTransition);
          oldCurrent.classList.remove('current');
        }
        if (newCurrent) {
          newCurrent.classList.toggle('no-transition', !enableTransition);
          newCurrent.classList.add('current');
        } else {
          endDate = this.makeDate(this.date, '00:00');
        }

        clearTimeout(this.timer);
        if (now < endDate) {
          console.log('Setting updateCurrentEntry timer for ' + endDate);
          var that = this;
          this.timer = setTimeout(
              function() { that.updateSelectedEntry(true); }, endDate - now);
        }
      },
      handleTrack: function(e) {
        switch (e.detail.state) {
          case 'start':
            this.enableTransition(false);
            this.axis = (Math.abs(e.detail.dx) >
                         Math.abs(e.detail.dy)) ? 'x' : 'y';
            break;
          case 'track':
            if (this.axis == 'x') {
              this.translateX(e.detail.dx);
            }
            break;
          case 'end':
            this.axis = undefined;
            this.enableTransition(true);
            this.maybeSwipe(e.detail.dx);
            break;
        }
      },
      enableTransition: function(enable) {
        this.classList.toggle('no-transition', !enable);
      },
      translateX: function(x) {
        var s = this.style;
        var translate = 'translate3d(' + x + 'px,0,0)';
        s.transform = s.webkitTransform = translate;
      },
      maybeSwipe: function(dx) {
        // If we've moved more than 1/4 of our width, swipe away
        this.swiped = Math.abs(dx) > this.offsetWidth / 4;
        if (this.swiped) {
          this.dest = (window.innerWidth + this.offsetWidth + 1) / 2 *
                      (dx / Math.abs(dx));
          this.translateX(this.dest);
        } else {
          this.translateX(0);
        }
      },
      transitionEnd: function(e) {
        // When we swipe offscreen, fire an event, silently switch to the
        // other side of the screen, and then transition back to the center.
        if (this.swiped) {
          var dir = (this.dest < 0) ? 'left' : 'right';
          this.fire('swiped', {direction: dir});
          this.swiped = false;
          this.enableTransition(false);
          this.translateX(-this.dest);
          this.dest = null;

          var that = this;
          setTimeout(function() {
            that.enableTransition(true);
            that.translateX(0);
          }, 0);
        }
      },

      hasTeacherAndRoom: function(item) {
        return item.teacherLastName && item.room;
      },
      hasTeacherOnly: function(item) {
        return item.teacherLastName && !item.room;
      },
      hasRoomOnly: function(item) {
        return !item.teacherLastName && item.room;
      },
      computeCollapseId: function(name) {
        return "collapse-" + name;
      },
      computeEmailLink: function(email) {
        return "mailto:" + email;
      },
      toggleExpand: function(e) {
        // if expanding, XHR, and then set model
        var el = e.currentTarget;
        el.classList.toggle("selected");
        var item = this.$.entryList.itemForElement(el);
        var collapse = document.getElementById(this.computeCollapseId(item.name));
        if (el.classList.contains("selected")) {
          var xhr = new XMLHttpRequest();
          var cleanedClass = item.name.replace(/ /g, '_').replace(/\./g, '');
          var url = "class/" + cleanedClass + "/" + item.period.toLowerCase();
          xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
              var obj = JSON.parse(this.responseText);
              e.model.set('item.students', obj.students);
              collapse.toggle();
            }
          }
          xhr.open("GET", url, true);
          xhr.send();
        } else {
          collapse.toggle();
          //e.model.set('item.students', []);
        }
      },
      studentThunk: function(e) {
        e.stopPropagation()
        if (this.onStudentTap) {
          this.onStudentTap(e);
        }
      },
      roomThunk: function(e) {
        e.stopPropagation()
        if (this.onRoomTap) {
          this.onRoomTap(e);
        }
      },
      teacherThunk: function(e) {
        e.stopPropagation()
        if (this.onTeacherTap) {
          this.onTeacherTap(e);
        }
      }
    });
  </script>
</dom-module>
